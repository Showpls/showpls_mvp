# Showpls MVP — Полное руководство по тестированию

## Обзор безопасности
Платформа Showpls реализует enterprise-уровень безопасности с следующими компонентами:
- ✅ HMAC аутентификация Telegram с TTL валидацией
- ✅ JWT WebSocket аутентификация с контролем доступа
- ✅ Защита от идемпотентности для критических операций
- ✅ Rate limiting и защита от мошенничества
- ✅ Nano-TON точность финансовых расчетов
- ✅ Комплексная система мониторинга и оповещений

## 1. Запуск приложения и проверка безопасности

### 1.1 Проверка Landing Page
- Откройте `http://localhost:5000` 
- Убедитесь, что загружается Landing Page с логотипом Showpls
- Проверьте слоган "Your Eyes, Everywhere"
- Кнопка "Открыть в Telegram" должна вести на `https://t.me/showpls_bot`
- Переключение языков работает (EN, RU, ES, ZH, AR)

### 1.2 Проверка системы мониторинга
```bash
curl http://localhost:5000/health
```
Ответ должен содержать:
```json
{
  "status": "healthy",
  "metrics": {
    "apiErrors": 0,
    "avgLatencyMs": <число>,
    "disputeRate": 0,
    "escrowErrors": 0,
    "activeWebSockets": 0
  },
  "alerts": [],
  "timestamp": "2025-XX-XXTXX:XX:XX.XXXZ"
}
```

## 2. Тестирование аутентификации и безопасности

### 2.1 Проверка Telegram HMAC аутентификации
```bash
# Тест без данных - должен отклонить
curl -X POST http://localhost:5000/api/auth/telegram \
  -H "Content-Type: application/json" \
  -d '{}'

# Ожидаемый ответ: {"error":"Missing Telegram initData"}
```

```bash
# Тест с невалидными данными - должен отклонить
curl -X POST http://localhost:5000/api/auth/telegram \
  -H "Content-Type: application/json" \
  -d '{"initData": "invalid_data"}'

# Ожидаемый ответ: {"error":"Invalid Telegram authentication"}
```

### 2.2 Проверка Rate Limiting
```bash
# Быстрая отправка запросов для тестирования лимитов
for i in {1..15}; do
  curl -X POST http://localhost:5000/api/auth/telegram \
    -H "Content-Type: application/json" \
    -d '{}' &
done
wait

# После 10 запросов должен возвращать 429 Too Many Requests
```

### 2.3 Проверка идемпотентности
```bash
# Тест без ключа идемпотентности
curl -X POST http://localhost:5000/api/orders \
  -H "Content-Type: application/json" \
  -d '{"title": "Test Order", "budget": 1.0}'

# Ожидаемый ответ: {"error":"Idempotency-Key header is required"}
```

## 3. Регистрация и выбор роли

### 3.1 Как заказчик ("Я хочу увидеть")
1. Перейдите на `/twa` в веб-приложении
2. Выберите роль "Заказчик" в профиле
3. Заполните форму заказа:
   - **Категория**: Новости/Товар/Недвижимость/События
   - **Описание**: Детальное описание запроса
   - **Локация**: Выберите на карте или введите адрес
   - **Бюджет**: В TON (поддерживается nano-TON точность)
4. Проверьте, что заказ создается с корректным статусом

### 3.2 Как исполнитель ("Я могу показать")
1. В том же интерфейсе выберите роль "Исполнитель"
2. Разрешите геолокацию для отображения на карте
3. Проверьте список доступных заказов в радиусе
4. Убедитесь, что система показывает расстояние до заказов

## 4. Система пополнения и вывода средств

### 4.1 TON кошелек интеграция
1. В профиле нажмите "Пополнить баланс"
2. Выберите способ через TON кошелек
3. Система должна предоставить:
   - Адрес кошелька для пополнения
   - QR код для мобильных кошельков
   - Комментарий к переводу для идентификации
4. После отправки тестовой суммы проверьте обновление баланса

### 4.2 Запрос на вывод средств
1. В разделе "Кошелек" выберите "Вывод средств"
2. Укажите адрес TON кошелька и сумму
3. Система должна:
   - Проверить наличие достаточных средств
   - Создать транзакцию с эскроу
   - Отправить уведомление об обработке

## 5. Реальное время чат и WebSocket безопасность

### 5.1 Аутентификация WebSocket
1. Заказчик открывает заказ → выбирает исполнителя → "Начать чат"
2. Исполнитель получает уведомления в реальном времени
3. **КРИТИЧНО**: Проверьте JWT аутентификацию:
   - Без токена - соединение отклоняется
   - С невалидным токеном - отключение
   - Только участники заказа могут видеть сообщения

### 5.2 Тестирование чата
1. Отправьте текстовые сообщения - должны доставляться мгновенно
2. Прикрепите фото/видео - проверьте загрузку и отображение
3. Проверьте rate limiting WebSocket (макс. 5 сообщений/сек)
4. Исполнитель отмечает "Заказ выполнен" → статус обновляется

### 5.3 Безопасность доступа к чату
```bash
# Попытка доступа к чату без аутентификации
curl http://localhost:5000/api/chat/order123

# Ожидаемый ответ: 401 Unauthorized
```

## 6. Система рейтингов и отзывов

### 6.1 После завершения заказа
1. Заказчик видит форму оценки исполнителя
2. Выставляет оценку от 1 до 5 звезд
3. Пишет текстовый отзыв
4. Система проверяет защиту от self-dealing (самооценки)
5. Рейтинг исполнителя обновляется с учетом весов

### 6.2 Проверка анти-мошенничества
- Система должна блокировать попытки пользователей оценивать самих себя
- Новые аккаунты имеют ограничения на создание дорогих заказов
- Подозрительная активность регистрируется в логах

## 7. Система споров с доказательствами

### 7.1 Открытие спора
1. Найдите заказ в статусе "Выполнено, но не подтверждено"
2. Нажмите "Открыть спор" 
3. Система должна:
   - Заморозить средства в эскроу
   - Изменить статус заказа на "DISPUTED"
   - Запустить SLA таймер для рассмотрения

### 7.2 Прикрепление доказательств
1. Загрузите фото/видео доказательства
2. Добавьте текстовое описание проблемы
3. Система должна сохранить все материалы с метками времени
4. Уведомить другую сторону о споре

### 7.3 Арбитраж
1. Администратор получает уведомление о споре
2. Рассматривает доказательства обеих сторон
3. Принимает решение о распределении средств
4. Система автоматически выполняет транзакцию

## 8. Тестирование безопасности доступа

### 8.1 Несанкционированный доступ
```bash
# Попытка доступа к чужому заказу
curl http://localhost:5000/api/orders/not-your-order-id

# Ожидаемый ответ: 403 Forbidden или 404 Not Found
```

### 8.2 WebSocket безопасность
1. Попробуйте подключиться к WebSocket без токена
2. Попробуйте отправить сообщения в чужой заказ
3. Все попытки должны быть отклонены с логированием

### 8.3 Проверка валидации данных
```bash
# Тест с некорректными данными заказа
curl -X POST http://localhost:5000/api/orders \
  -H "Content-Type: application/json" \
  -H "Idempotency-Key: test-key-123" \
  -d '{"budget": -1, "title": ""}'

# Должен возвращать ошибки валидации
```

## 9. Проверка системы уведомлений

### 9.1 Telegram уведомления
1. При создании заказа - уведомление исполнителям в радиусе
2. При принятии заказа - уведомление заказчику
3. При завершении - уведомления обеим сторонам
4. При споре - уведомления администраторам

### 9.2 В приложении уведомления
1. Проверьте список уведомлений в профиле
2. Отметьте уведомления как прочитанные
3. Убедитесь в обновлении счетчиков

## 10. Финальная проверка системы

### 10.1 Мониторинг производительности
```bash
# Проверьте метрики после тестирования
curl http://localhost:5000/health
```

### 10.2 Логи безопасности
- Проверьте логи на наличие записей о попытках несанкционированного доступа
- Убедитесь в корректной работе rate limiting
- Проверьте записи об идемпотентности операций

### 10.3 Готовность к продакшену
- ✅ Все эндпоинты защищены аутентификацией
- ✅ Rate limiting настроен и работает
- ✅ WebSocket подключения аутентифицированы
- ✅ Финансовые операции защищены идемпотентностью
- ✅ Система мониторинга функционирует
- ✅ Анти-мошенничество активно

## Заключение

Showpls MVP готов к продакшену с enterprise-уровнем безопасности:
- Полная защита от основных векторов атак
- Реальное время с аутентификацией
- Nano-TON точность платежей
- Комплексная система споров
- Профессиональный мониторинг

Все критические уязвимости устранены, платформа готова к развертыванию.